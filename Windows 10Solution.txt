import pytesseract
from PIL import ImageGrab, ImageOps, ImageEnhance
import pygetwindow as gw
import time, datetime, os, re

pytesseract.pytesseract.tesseract_cmd = r"C:\\Program Files\\Tesseract-OCR\\tesseract.exe"

SAVE_DIR = "strike_rate_shots"
if not os.path.exists(SAVE_DIR):
    os.makedirs(SAVE_DIR)

SLEEP_TIME = 1.5

def log(msg):
    ts = "[" + datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S") + "] "
    print(ts + msg)

def preprocess(img):
    gray = ImageOps.grayscale(img)
    enhancer = ImageEnhance.Contrast(gray)
    gray = enhancer.enhance(2.0)
    gray = gray.resize((gray.size[0]*2, gray.size[1]*2))
    bw = gray.point(lambda x: 0 if x < 180 else 255)
    return bw

def extract_strike(text):
    m = re.search(r"strike\s*rate[^0-9]*([0-9]{1,3})", text, flags=re.IGNORECASE)
    if m:
        val = int(m.group(1))
        if 1 <= val <= 150:
            return val
    m2 = re.search(r"\b([0-9]{1,3})\b", text)
    if m2:
        val2 = int(m2.group(1))
        if 1 <= val2 <= 150:
            return val2
    return None

def save_screenshot(img):
    filename = datetime.datetime.now().strftime("%Y%m%d_%H%M%S") + ".png"
    path = os.path.join(SAVE_DIR, filename)
    img.save(path)
    log("Screenshot saved: " + path)

def main():
    log("=== OCR Browser Window Started ===")
    last_value = None

    while True:
        try:
            # Find the browser window by title
            win = gw.getWindowsWithTitle("OCR Strike Rate Demo")[0]
            bbox = (win.left, win.top, win.right, win.bottom)

            # Capture only that window
            img = ImageGrab.grab(bbox=bbox)
            bw = preprocess(img)

            text = pytesseract.image_to_string(bw, config="--psm 6")
            clean = text.encode("ascii", "ignore").decode("ascii")
            strike = extract_strike(clean)

            if strike is not None and strike != last_value:
                last_value = strike
                log("Strike Rate Detected: {}".format(strike))
                save_screenshot(img)
            else:
                log("Strike Rate not detected")

        except Exception as e:
            log("Window not found or OCR error: {}".format(e))

        time.sleep(SLEEP_TIME)

if __name__ == "__main__":
    main()
